name: Backend Lambda Deployment

# TRIGGER CONDITIONS
# This workflow only runs when backend code changes
on:
  push:
    branches:
      - main
    paths:
      - 'backend/serverless-resume-website/**'  # Only trigger on backend changes
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    # Set working directory for all steps
    defaults:
      run:
        working-directory: backend/serverless-resume-website

    steps:
      # STEP 1: Get the code
      # Why: GitHub Actions needs your code to work with it
      - name: Checkout code
        uses: actions/checkout@v3

      # STEP 2: Set up Python
      # Why: Your Lambda function is Python, so we need Python installed
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  # Match your Lambda runtime

      # STEP 3: Install SAM CLI
      # Why: SAM CLI is needed to build and deploy serverless apps
      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli
          sam --version

      # STEP 4: Configure AWS credentials
      # Why: GitHub needs permission to deploy to your AWS account
      # Security: Uses GitHub Secrets (never exposes credentials in logs)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # STEP 5: Validate SAM template
      # Why: Catch syntax errors in template.yaml before deploying
      - name: Validate SAM template
        run: sam validate --lint

      # STEP 6: Run Python tests (if they exist)
      # Why: Don't deploy broken code to production
      - name: Run unit tests
        run: |
          if [ -f "tests/requirements.txt" ]; then
            pip install -r tests/requirements.txt
          fi
          # Skip tests if test directory is empty or tests don't exist
          if [ -f "tests/unit/test_handler.py" ]; then
            python -m pytest tests/unit/ -v
          else
            echo "No unit tests found, skipping..."
          fi
        continue-on-error: false  # Stop deployment if tests fail

      # STEP 7: Build the Lambda function
      # Why: Packages your Python code and dependencies for Lambda
      # What it does: Creates .aws-sam/ folder with built artifacts
      - name: Build SAM application
        run: sam build --use-container

      # STEP 8: Deploy to AWS
      # Why: Actually update the Lambda function in AWS
      # --no-confirm-changeset: Don't ask for confirmation (auto-approve)
      # --no-fail-on-empty-changeset: Don't fail if nothing changed
      - name: Deploy to AWS
        run: |
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name serverless-resume-web-app \
            --capabilities CAPABILITY_IAM \
            --region us-east-1

      # STEP 9: Get the API Gateway URL
      # Why: Confirm deployment worked and show the endpoint
      - name: Get API Gateway URL
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name serverless-resume-web-app \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiURL`].OutputValue' \
            --output text)
          echo "API Gateway URL: $API_URL"

      # STEP 10: Health check (optional but recommended)
      # Why: Verify the Lambda is actually working after deployment
      - name: Test deployed endpoint
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name serverless-resume-web-app \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiURL`].OutputValue' \
            --output text)

          if [ ! -z "$API_URL" ]; then
            echo "Testing endpoint: ${API_URL}counter"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${API_URL}counter)
            if [ $RESPONSE -eq 200 ]; then
              echo "✅ Health check passed! Lambda is working."
            else
              echo "❌ Health check failed with status code: $RESPONSE"
              exit 1
            fi
          else
            echo "⚠️  Could not find API URL, skipping health check"
          fi
